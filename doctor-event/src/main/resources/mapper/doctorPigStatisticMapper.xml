<?xml version="1.0" encoding="UTF-8" ?>
<!--
  ~ Copyright (c) 2016 杭州端点网络科技有限公司, Code Generated by terminus code gen
  -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="DoctorPigStatistic">

    <sql id="criteria">
        status = 1
        AND event_source != 5
        <if test="farmId != null">AND farm_id = #{farmId}</if>
        <if test="sumAt != null">AND event_at = #{sumAt}</if>
        <if test="startAt != null">AND event_at &gt;= #{startAt}</if>
        <if test="endAt != null">AND event_at &lt;= #{endAt}</if>
    </sql>

    <!-- 实时存栏: 在产房的母猪 -->
    <select id="cfLiveStock" parameterType="map" resultType="int">
        select
        (
        SELECT ifnull(count(1) , 0)
        FROM doctor_pig_tracks a
        left join doctor_barns b on a.current_barn_id = b.id
        WHERE
        a.farm_id = #{farmId} AND
        a.is_removal = 0 AND
        b.pig_type = 7 -- 产房
        )
        -
        (
        SELECT
        ifnull(sum(case type when 20 then 1 when 14 then 1 else 0 end ), 0) -
        ifnull(sum(case type when 6 then 1 when 10 then 1 when 12 then 1 else 0 end ), 0)
        FROM doctor_pig_events a
        WHERE
        a.farm_id = #{farmId} AND
        a.event_at &gt; #{sumAt} AND
        a.kind = 1 AND
        (a.barn_type = 7 or type = 14) and
        a.status = 1 and
        a.event_source != 5
        );
    </select>

    <select id="phLiveStock" parameterType="map" resultType="int">
        select
        (
        SELECT ifnull(count(1) , 0)
        FROM doctor_pig_tracks a
        left join doctor_barns b on a.current_barn_id = b.id
        WHERE
        a.farm_id = #{farmId} AND
        a.is_removal = 0 AND
        a.pig_type = 1 and
        b.pig_type in (5 ,6 ) -- 配怀舍
        )
        -
        (
        SELECT
        ifnull(sum(case type when 7 then 1 when 12 then 1 else 0 end ), 0) -
        ifnull(sum(case type when 2 then 1 when 6 then 1 when 14 then 1 else 0 end ), 0)
        FROM doctor_pig_events
        WHERE
        farm_id = #{farmId} AND
        event_at &gt; #{sumAt} AND
        kind = 1 AND
        status = 1 AND
        event_source != 5 AND
        (( barn_type in ( 5, 6 ) and type in(2,6,7,14) ) OR ( barn_type = 7 and type = 12 ) )  -- 保育舍发生的转场+销售+转分娩舍-(产房发生的进场+转配怀舍)
        )
    </select>

    <select id="sowPhReserveIn" parameterType="map" resultType="int" >
        SELECT
        ifnull(count(*),0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria"/>
            and type = 7
            and rel_group_event_id is not null
            and barn_type in(5,6)
        </where>
    </select>

    <select id="sowPhWeanIn" parameterType="map" resultType="int">
        SELECT
        ifnull(count(1), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria"/>
            and `type` = 12
            and pig_status_before = 9
        </where>
    </select>

    <select id="sowPhEntryIn" parameterType="map" resultType="int">
        SELECT
        ifnull(count(1), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria"/>
            and kind = 1
            and type = 7
        </where>
    </select>

    <select id="sowPhChgFarmIn" parameterType="map" resultType="int">
        SELECT
        ifnull(count(1), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria"/>
            and kind = 1
            and type = 20
        </where>
    </select>

    <select id="sowPhDead" parameterType="map" resultType="int">
        SELECT
        ifnull(count(1), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria"/>
            and type = 6
            and change_type_id = 110
            and barn_type in (5,6)
        </where>
    </select>

    <select id="sowPhWeedOut" parameterType="map" resultType="int">
        SELECT
        ifnull(count(1), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria"/>
            and type = 6
            and change_type_id = 111
            and barn_type in (5,6)
        </where>
    </select>

    <select id="sowPhSale" parameterType="map" resultType="int">
        SELECT
        ifnull(count(1), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria"/>
            and type = 6
            and change_type_id = 109
            and barn_type in (5,6)
        </where>
    </select>

    <select id="sowPhChgFarm" parameterType="map" resultType="int">
        SELECT
        ifnull(count(1), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria"/>
            and type = 2
            and barn_type in (5,6)
        </where>
    </select>

    <select id="sowPhOtherOut" parameterType="map" resultType="int">
        SELECT ifnull(count(1), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria" />
            AND `type` = 6
            AND barn_type in (5,6)
            AND change_type_id not in( 109, 110, 111)
        </where>
    </select>

    <!-- 配后备-->
    <select id="mateHb" parameterType="map" resultType="int">
        select ifnull(count(1),0)
        from doctor_pig_events
        <where>
            <include refid="criteria" />
            and `type` = 9
            and kind = 1
            and `doctor_mate_type` = 1
            and `current_mating_count` = 1
        </where>
    </select>

    <!-- 配流产-->
    <select id="mateLc" parameterType="map" resultType="int">
        select ifnull(count(1),0)
        from doctor_pig_events
        <where>
            <include refid="criteria" />
            and `type` = 9
            and kind = 1
            and `doctor_mate_type` in (2, 3)
            and `current_mating_count` = 1
        </where>
    </select>

    <!-- 配断奶-->
    <select id="mateDn" parameterType="map" resultType="int">
        select ifnull(count(1),0)
        from doctor_pig_events
        <where>
            <include refid="criteria" />
            and `type` = 9
            and kind = 1
            and `doctor_mate_type` = 4
            and `current_mating_count` = 1
        </where>
    </select>

    <!-- 配阴性-->
    <select id="mateYx" parameterType="map" resultType="int">
        select ifnull(count(1),0)
        from doctor_pig_events
        <where>
            <include refid="criteria" />
            and `type` = 9
            and kind = 1
            and `doctor_mate_type` = 5
            and `current_mating_count` = 1
        </where>
    </select>

    <!-- 配返情-->
    <select id="mateFq" parameterType="map" resultType="int">
        select ifnull(count(1),0) from doctor_pig_events
        <where>
            <include refid="criteria" />
            and `type` = 9
            and kind = 1
            and `doctor_mate_type` = 6
            and `current_mating_count` = 1
        </where>

    </select>

    <select id="matingCount" parameterType="map" resultType="int">
        SELECT ifnull(count(1), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria" />
            AND `type` = 9
            AND barn_type in (5,6)
        </where>
    </select>

    <select id="pregPositive" parameterType="map" resultType="int">
        SELECT ifnull(count(1), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria" />
            AND `type` = 11
            AND preg_check_result = 1
            AND barn_type in (5,6)
        </where>
    </select>

    <select id="pregNegative" parameterType="map" resultType="int">
        SELECT ifnull(count(1), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria" />
            AND `type` = 11
            AND preg_check_result = 2
            AND barn_type in (5,6)
        </where>
    </select>

    <select id="pregFanqing" parameterType="map" resultType="int">
        SELECT ifnull(count(1), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria" />
            AND `type` = 11
            AND preg_check_result = 4
            AND barn_type in (5,6)
        </where>
    </select>

    <select id="pregLiuchan" parameterType="map" resultType="int">
        SELECT ifnull(count(1), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria" />
            AND `type` = 11
            AND preg_check_result = 3
            AND barn_type in (5,6)
        </where>
    </select>

    <select id="sowCfIn" parameterType="map" resultType="int">
        SELECT ifnull(count(1), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria" />
            AND `type` = 14
        </where>
    </select>

    <select id="sowCfInFarmIn" parameterType="map" resultType="int">
        SELECT ifnull(count(1), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria" />
            and kind = 1
            AND `type` = 20
            AND barn_type = 7
        </where>
    </select>

    <select id="sowCfDead" parameterType="map" resultType="int">
        SELECT
        ifnull(count(1), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria"/>
            and type = 6
            and change_type_id = 110
            and barn_type = 7
        </where>
    </select>

    <select id="sowCfWeedOut" parameterType="map" resultType="int">
        SELECT
        ifnull(count(1), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria"/>
            and type = 6
            and change_type_id = 111
            and barn_type = 7
        </where>
    </select>

    <select id="sowCfSale" parameterType="map" resultType="int">
        SELECT
        ifnull(count(1), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria"/>
            and type = 6
            and change_type_id = 109
            and barn_type = 7
        </where>
    </select>

    <select id="sowCfChgFarm" parameterType="map" resultType="int">
        SELECT
        ifnull(count(1), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria"/>
            and type = 2
            and barn_type = 7
        </where>
    </select>

    <select id="sowCfOtherOut" parameterType="map" resultType="int">
        SELECT ifnull(count(1), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria" />
            AND `type` = 6
            AND barn_type = 7
            AND change_type_id not in( 109, 110, 111)
        </where>
    </select>

    <select id="earlyFarrowNest" parameterType="map" resultType="int">
        select count(1)
        from doctor_pig_events  a left join doctor_pig_events b on a.pig_id = b.pig_id
        where a.farm_id =#{farmId}
        and a.type = 9
        and a.`current_mating_count` = 1
        and a.event_at = #{sumAt}
        and b.type = 15
        and a.`parity` = b.`parity`
        group by a.pig_id;
    </select>

    <select id="farrowNest" parameterType="map" resultType="int">
        SELECT ifnull(count(1), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria" />
            AND `type` = 15
        </where>
    </select>

    <select id="farrowLive" parameterType="map" resultType="int">
        SELECT ifnull(sum(live_count), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria" />
            AND `type` = 15
        </where>
    </select>

    <select id="farrowHealth" parameterType="map" resultType="int">
        SELECT ifnull(sum(health_count), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria" />
            AND `type` = 15
        </where>
    </select>

    <select id="farrowWeak" parameterType="map" resultType="int">
        SELECT ifnull(sum(weak_count), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria" />
            AND `type` = 15
        </where>
    </select>

    <select id="farrowDead" parameterType="map" resultType="int">
        SELECT ifnull(sum(dead_count), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria" />
            AND `type` = 15
        </where>
    </select>

    <select id="farrowjmh" parameterType="map" resultType="int">
        SELECT ifnull(sum(mny_count), 0) + ifnull(sum(jx_count), 0) + ifnull(sum(jx_count), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria" />
            AND `type` = 15
        </where>
    </select>

    <select id="farrowWeight" parameterType="map" resultType="double">
        SELECT ifnull(sum(farrow_weight), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria" />
            AND `type` = 15
        </where>
    </select>

    <select id="weanNest" parameterType="map" resultType="int">
        SELECT ifnull(sum(farrow_weight), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria" />
            AND `type` = 16
        </where>
    </select>

    <select id="weanQualifiedCount" parameterType="map" resultType="int">
        SELECT ifnull(sum(health_count), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria" />
            AND `type` = 16
        </where>
    </select>

    <select id="weanCount" parameterType="map" resultType="int">
        SELECT ifnull(sum(wean_count), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria" />
            AND `type` = 16
        </where>
    </select>

    <select id="weanWeight" parameterType="map" resultType="double">
        SELECT ifnull(sum(wean_avg_weight), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria" />
            AND `type` = 16
        </where>
    </select>

    <select id="boarLiveStock" parameterType="map" resultType="int">
        SELECT
        (
        select ifnull(count(*), 0 )
        from doctor_pig_tracks
        where
        farm_id = #{farmId}
        and status = 11
        )
        -
        (
        SELECT ifnull(sum(
        case
        when `type` = 6 then 1
        when `type` in (7,20) then -1 else 0
        END
        ),0)
        FROM doctor_pig_events
        <where>
            farm_id = #{farmId}
            AND event_at > #{sumAt}
            AND `type` IN (6, 7, 20)
            AND kind = 2
            AND boar_type = 1
        </where>
        )
        FROM dual
    </select>

    <select id="boarIn" parameterType="map" resultType="int">
        SELECT ifnull(sum(wean_avg_weight), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria" />
            AND `type` IN (7, 20)
            AND boar_type = 1
            AND kind = 2
        </where>
    </select>

    <select id="boarDead" parameterType="map" resultType="int">
        SELECT
        ifnull(count(1), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria"/>
            and type = 6
            and change_type_id = 110
            and kind = 2
        </where>
    </select>

    <select id="boarWeedOut" parameterType="map" resultType="int">
        SELECT
        ifnull(count(1), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria"/>
            and type = 6
            and change_type_id = 111
            and kind = 2
        </where>
    </select>

    <select id="boarSale" parameterType="map" resultType="int">
        SELECT
        ifnull(count(1), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria"/>
            and type = 6
            and change_type_id = 109
            and kind = 2
        </where>
    </select>

    <select id="boarOtherOut" parameterType="map" resultType="int">
        SELECT
        ifnull(count(1), 0)
        FROM doctor_pig_events
        <where>
            <include refid="criteria"/>
            and kind = 2
            and (`type` = 2 OR ( `type`= 6 and change_type_id not in (109,110,111)))
        </where>
    </select>
</mapper>