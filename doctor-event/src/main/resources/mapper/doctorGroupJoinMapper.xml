<?xml version="1.0" encoding="UTF-8" ?>
<!--
  ~ Copyright (c) 2016 杭州端点网络科技有限公司, Code Generated by terminus code gen
  -->

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="SearchedGroup">

    <sql id="criteria">
        <if test="orgId != null">AND a.org_id = #{orgId}</if>
        <if test="farmId != null">AND a.farm_id = #{farmId}</if>
        <if test="status != null">AND a.status = #{status}</if>
        <if test="initBarnId != null">AND a.init_barn_id = #{initBarnId}</if>
        <if test="currentBarnId != null">AND a.current_barn_id = #{currentBarnId}</if>
        <if test="barnIdList != null">
            and current_barn_id in
            <foreach collection="barnIdList" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="pigType != null">AND a.pig_type = #{pigType}</if>
        <if test="pigTypes != null  &amp;&amp; pigTypes.size() > 0">AND a.pig_type IN
            <foreach collection="pigTypes" item="type" open="(" separator="," close=")">
                #{type}
            </foreach>
        </if>
        <if test="breedId != null">AND a.breed_id = #{breedId}</if>
        <if test="geneticId != null">AND a.genetic_id = #{geneticId}</if>
        <if test="startOpenAt != null">AND a.open_at &gt;= #{startOpenAt}</if>
        <if test="endOpenAt != null">AND a.open_at &lt;= #{endOpenAt}</if>
        <if test="startCloseAt != null">AND a.close_at &gt;= #{startCloseAt}</if>
        <if test="endCloseAt != null">AND a.close_at &lt;= #{endCloseAt}</if>
        <if test="groupCode != null">AND a.group_code like concat('%', #{groupCode}, '%') </if>
    </sql>

    <select id="getPigCount" parameterType="map" resultType="long">
        SELECT ifnull(sum(b.quantity), 0) from doctor_groups a
        left join doctor_group_tracks b on a.id = b.group_id
        <where>
            <include refid="criteria"/>
        </where>
    </select>


    <select id="getWeanCount" parameterType="map" resultType="long">
        SELECT ifnull(sum(b.quantity-b.unwean_qty), 0) from doctor_groups a
        left join doctor_group_tracks b on a.id = b.group_id
        <where>
            <include refid="criteria"/>
        </where>
    </select>
    
    
    <select id="findGroupCount" parameterType="long" resultType="io.terminus.doctor.event.dto.search.DoctorGroupCountDto" >
        select
        ifnull(max(nurseryPigletCount),0) nurseryPigletCount,
        ifnull(max(fattenPigCount),0) fattenPigCount,
        ifnull(max(reserveCount),0) reserveCount,
        ifnull(max(deliverPigCount),0) deliverPigCount
        from(
        select
        (case pig_type when 2 then sum(quantity) end) nurseryPigletCount,
        (case pig_type when 3 then sum(quantity) end) fattenPigCount,
        (case pig_type when 4 then sum(quantity) end) reserveCount,
        (case pig_type when 7 then sum(quantity) end) deliverPigCount
        from doctor_group_tracks a left join doctor_groups b on a.group_id = b.id
        where b.status != -1 and farm_id = #{farmId}
        group by pig_type) t;
    </select>

</mapper>