<?xml version="1.0" encoding="UTF-8" ?>
<!--
  ~ Copyright (c) 2016 杭州端点网络科技有限公司, Code Generated by terminus code gen
  -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="DoctorWarehouseReportDao">


    <!--产房母猪-->
    <select id="countFarrowSow" parameterType="map" resultType="map">
        SELECT
        ifnull(max(CASE WHEN type = 1 THEN amount ELSE 0 END), 0) AS farrowSowFeedAmount,
        ifnull(max(CASE WHEN type = 1 THEN quantity ELSE 0 END), 0) AS farrowSowFeedCount,
        ifnull(max(CASE WHEN type = 2 THEN amount ELSE 0 END), 0) AS farrowSowMaterialAmount,
        ifnull(max(CASE WHEN type = 2 THEN quantity ELSE 0 END), 0) AS farrowSowMaterialCount,
        ifnull(max(CASE WHEN type = 3 THEN amount ELSE 0 END), 0) AS farrowSowVaccineAmount,
        ifnull(max(CASE WHEN type = 4 THEN amount ELSE 0 END), 0) AS farrowSowDrugAmount,
        ifnull(max(CASE WHEN type = 5 THEN amount ELSE 0 END), 0) AS farrowSowConsumerAmount

        FROM
        (
        SELECT sum(quantity) AS quantity,sum(quantity * unit_price) AS amount,type
        FROM doctor_warehouse_material_apply
        WHERE apply_type=2
        <if test="farmId != null and farmId.size() >0">AND farm_id in
            <foreach item="id" collection="farmId" open="(" separator="," close=")">
                #{id}
            </foreach>
        </if>
        <if test="startAt != null">AND apply_date &gt;= #{startAt}</if>
        <if test="endAt != null">AND apply_date &lt;= #{endAt}</if>
        GROUP BY type
        ) AS a
    </select>

    <!--产房仔猪-->
    <select id="countFarrow" parameterType="map" resultType="map">
        SELECT
        ifnull(max(CASE WHEN type = 1 THEN amount ELSE 0 END), 0) AS farrowFeedAmount,
        ifnull(max(CASE WHEN type = 1 THEN quantity ELSE 0 END), 0) AS farrowFeedCount,
        ifnull(max(CASE WHEN type = 2 THEN amount ELSE 0 END), 0) AS farrowMaterialAmount,
        ifnull(max(CASE WHEN type = 2 THEN quantity ELSE 0 END), 0) AS farrowMaterialCount,
        ifnull(max(CASE WHEN type = 3 THEN amount ELSE 0 END), 0) AS farrowVaccineAmount,
        ifnull(max(CASE WHEN type = 4 THEN amount ELSE 0 END), 0) AS farrowDrugAmount,
        ifnull(max(CASE WHEN type = 5 THEN amount ELSE 0 END), 0) AS farrowConsumerAmount
        FROM
        (
        SELECT sum(quantity) AS quantity,sum(quantity * unit_price) AS amount,type
        FROM doctor_warehouse_material_apply t0 LEFT JOIN doctor_barns t1 on t0.pig_barn_id=t1.id
        WHERE apply_type=1 and (t1.pig_type=1 or t1.pig_type=7)
        <if test="farmId != null and farmId.size() >0">AND t0.farm_id in
            <foreach item="id" collection="farmId" open="(" separator="," close=")">
                #{id}
            </foreach>
        </if>
        <if test="startAt != null">AND apply_date &gt;= #{startAt}</if>
        <if test="endAt != null">AND apply_date &lt;= #{endAt}</if>
        GROUP BY type
        ) AS a
    </select>


    <select id="count" parameterType="map" resultType="map">
        SELECT
        -- 保育
        ifnull(max(CASE WHEN pig_type = 2 and type = 1 THEN quantity ELSE 0 END), 0) AS nurseryFeedCount,
        ifnull(max(CASE WHEN pig_type = 2 AND type = 1 THEN amount ELSE 0 END), 0) AS nurseryFeedAmount,
        ifnull(max(CASE WHEN pig_type = 2 and type = 2 THEN quantity ELSE 0 END), 0) AS nurseryMaterialCount,
        ifnull(max(CASE WHEN pig_type = 2 AND type = 2 THEN amount ELSE 0 END), 0) AS nurseryMaterialAmount,
        ifnull(max(CASE WHEN pig_type = 2 AND type = 3 THEN amount ELSE 0 END), 0) AS nurseryVaccineAmount,
        ifnull(max(CASE WHEN pig_type = 2 AND type = 4 THEN amount ELSE 0 END), 0) AS nurseryDrugAmount,
        ifnull(max(CASE WHEN pig_type = 2 AND type = 5 THEN amount ELSE 0 END), 0) AS nurseryConsumerAmount,
        -- 育肥
        ifnull(max(CASE WHEN pig_type = 3 and type = 1 THEN quantity ELSE 0 END), 0) AS fattenFeedCount,
        ifnull(max(CASE WHEN pig_type = 3 AND type = 1 THEN amount ELSE 0 END), 0) AS fattenFeedAmount,
        ifnull(max(CASE WHEN pig_type = 3 and type = 2 THEN quantity ELSE 0 END), 0) AS fattenMaterialCount,
        ifnull(max(CASE WHEN pig_type = 3 AND type = 2 THEN amount ELSE 0 END), 0) AS fattenMaterialAmount,
        ifnull(max(CASE WHEN pig_type = 3 AND type = 3 THEN amount ELSE 0 END), 0) AS fattenVaccineAmount,
        ifnull(max(CASE WHEN pig_type = 3 AND type = 4 THEN amount ELSE 0 END), 0) AS fattenDrugAmount,
        ifnull(max(CASE WHEN pig_type = 3 AND type = 5 THEN amount ELSE 0 END), 0) AS fattenConsumerAmount,
        -- 后备
        ifnull(max(CASE WHEN pig_type = 4 and type = 1 THEN quantity ELSE 0 END), 0) +
        ifnull(max(CASE WHEN pig_type = 8 and type = 1 THEN quantity ELSE 0 END), 0) AS houbeiFeedCount,
        ifnull(max(CASE WHEN pig_type = 4 AND type = 1 THEN amount ELSE 0 END), 0) +
        ifnull(max(CASE WHEN pig_type = 8 AND type = 1 THEN amount ELSE 0 END), 0) AS houbeiFeedAmount,
        ifnull(max(CASE WHEN pig_type = 4 and type = 2 THEN quantity ELSE 0 END), 0) +
        ifnull(max(CASE WHEN pig_type = 8 and type = 2 THEN quantity ELSE 0 END), 0) AS houbeiMaterialCount,
        ifnull(max(CASE WHEN pig_type = 4 AND type = 2 THEN amount ELSE 0 END), 0) +
        ifnull(max(CASE WHEN pig_type = 8 AND type = 2 THEN amount ELSE 0 END), 0) AS houbeiMaterialAmount,
        ifnull(max(CASE WHEN pig_type = 4 AND type = 3 THEN amount ELSE 0 END), 0) +
        ifnull(max(CASE WHEN pig_type = 8 AND type = 3 THEN amount ELSE 0 END), 0) AS houbeiVaccineAmount,
        ifnull(max(CASE WHEN pig_type = 4 AND type = 4 THEN amount ELSE 0 END), 0) +
        ifnull(max(CASE WHEN pig_type = 8 AND type = 4 THEN amount ELSE 0 END), 0) AS houbeiDrugAmount,
        ifnull(max(CASE WHEN pig_type = 4 AND type = 5 THEN amount ELSE 0 END), 0) +
        ifnull(max(CASE WHEN pig_type = 8 AND type = 5 THEN amount ELSE 0 END), 0) AS houbeiConsumerAmount,
        -- 佩怀
        ifnull(max(CASE WHEN pig_type = 5 and type = 1 THEN quantity ELSE 0 END), 0) +
        ifnull(max(CASE WHEN pig_type = 6 and type = 1 THEN quantity ELSE 0 END), 0) AS peiHuaiFeedCount,
        ifnull(max(CASE WHEN pig_type = 5 AND type = 1 THEN amount ELSE 0 END), 0) +
        ifnull(max(CASE WHEN pig_type = 6 AND type = 1 THEN amount ELSE 0 END), 0) AS peiHuaiFeedAmount,
        ifnull(max(CASE WHEN pig_type = 5 and type = 2 THEN quantity ELSE 0 END), 0) +
        ifnull(max(CASE WHEN pig_type = 6 and type = 2 THEN quantity ELSE 0 END), 0) AS peiHuaiMaterialCount,
        ifnull(max(CASE WHEN pig_type = 5 AND type = 2 THEN amount ELSE 0 END), 0) +
        ifnull(max(CASE WHEN pig_type = 6 AND type = 2 THEN amount ELSE 0 END), 0) AS peiHuaiMaterialAmount,
        ifnull(max(CASE WHEN pig_type = 5 AND type = 3 THEN amount ELSE 0 END), 0) +
        ifnull(max(CASE WHEN pig_type = 6 AND type = 3 THEN amount ELSE 0 END), 0) AS peiHuaiVaccineAmount,
        ifnull(max(CASE WHEN pig_type = 5 AND type = 4 THEN amount ELSE 0 END), 0) +
        ifnull(max(CASE WHEN pig_type = 6 AND type = 4 THEN amount ELSE 0 END), 0) AS peiHuaiDrugAmount,
        ifnull(max(CASE WHEN pig_type = 5 AND type = 5 THEN amount ELSE 0 END), 0) +
        ifnull(max(CASE WHEN pig_type = 6 AND type = 5 THEN amount ELSE 0 END), 0) AS peiHuaiConsumerAmount,
        -- 公猪
        ifnull(max(CASE WHEN pig_type = 9 and type = 1 THEN quantity ELSE 0 END), 0) AS boarFeedCount,
        ifnull(max(CASE WHEN pig_type = 9 AND type = 1 THEN amount ELSE 0 END), 0) AS boarFeedAmount,
        ifnull(max(CASE WHEN pig_type = 9 and type = 2 THEN quantity ELSE 0 END), 0) AS boarMaterialCount,
        ifnull(max(CASE WHEN pig_type = 9 AND type = 2 THEN amount ELSE 0 END), 0) AS boarMaterialAmount,
        ifnull(max(CASE WHEN pig_type = 9 AND type = 3 THEN amount ELSE 0 END), 0) AS boarVaccineAmount,
        ifnull(max(CASE WHEN pig_type = 9 AND type = 4 THEN amount ELSE 0 END), 0) AS boarDrugAmount,
        ifnull(max(CASE WHEN pig_type = 9 AND type = 5 THEN amount ELSE 0 END), 0) AS boarConsumerAmount
        FROM
        (
        SELECT
        pig_type,
        sum(quantity) as quantity,
        sum(quantity * unit_price) AS amount,
        type
        FROM doctor_warehouse_material_apply t0
        LEFT JOIN doctor_barns t1 ON t0.pig_barn_id = t1.id
        WHERE apply_type = 0
        <if test="farmId != null and farmId.size() >0">AND t0.farm_id in
            <foreach item="id" collection="farmId" open="(" separator="," close=")">
                #{id}
            </foreach>
        </if>
        <if test="startAt != null">AND t0.apply_date &gt;= #{startAt}</if>
        <if test="endAt != null">AND t0.apply_date &lt;= #{endAt}</if>
        GROUP BY t1.pig_type, type
        ) AS a
    </select>

    <select id="findFarmId" parameterType="map" resultType="long">
        SELECT
        farm_id
        FROM doctor_warehouse_material_apply
        WHERE
        apply_date &gt;= #{startAt}
        AND apply_date &lt;= #{endAt}
        group by farm_id
    </select>

    <select id="countByOrg" parameterType="map" resultType="map">
        SELECT t1.org_id,type,pig_type,sum(quantity),sum(quantity * unit_price) AS amount
        from doctor_warehouse_material_apply t0
        LEFT JOIN doctor_farms t1 on t0.farm_id=t1.id
        LEFT JOIN doctor_barns t2 on t0.pig_barn_id=t2.id
        where apply_type=0
        GROUP BY t1.org_id,t2.pig_type,type;
    </select>


    <select id="materialApply" parameterType="io.terminus.doctor.event.dto.DoctorDimensionCriteria" resultType="double">
        select ifnull(sum(quantity), 0)
        from doctor_groups a left join `doctor_warehouse_material_apply` b
        on a.id = b.pig_group_id
        where
        a.status = -1
        and b.type = 1
        <if test="orzType == 2">AND a.org_id = #{orzId}</if>
        <if test="orzType == 3">AND  a.farm_id = #{orzId}</if>
        <if test="dateType == 1">AND date_format(a.close_at, '%y-%m-%d') = date_format(#{sumAt}, '%y-%m-%d')</if>
        <if test="dateType == 2">AND date_format(a.close_at, '%x-%v') = date_format(#{sumAt}, '%x-%v')</if>
        <if test="dateType == 3">AND date_format(a.close_at, '%y-%m') = date_format(#{sumAt}, '%y-%m')</if>
        <if test="dateType == 4">AND concat(date_format(a.close_at, '%y-'), QUARTER(a.close_at)) =
            concat(date_format(#{sumAt}, '%y-'), QUARTER(#{sumAt}))
        </if>
        <if test="dateType == 5">AND date_format(a.close_at, '%y') = date_format(#{sumAt}, '%y')</if>
        AND a.pig_type = #{pigType}
    </select>

</mapper>