<?xml version="1.0" encoding="UTF-8" ?>
<!--
  ~ Copyright (c) 2016 杭州端点网络科技有限公司, Code generated by terminus code gen
  -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="DoctorKpi">

    <sql id="criteria">
        <if test="farmId != null">AND farm_id = #{farmId}</if>
        <if test="startAt != null">AND event_at &gt;= #{startAt}</if>
        <if test="endAt != null">AND event_at &lt;= #{endAt}</if>
    </sql>

    <!-- 预产胎数-->
    <select id="preDeliveryCounts" parameterType="map" resultType="int">
        select count(1) from doctor_pig_events
        where type = 9
        and current_mating_count = 1
        <include refid="criteria"/>
    </select>

    <!-- 分娩窝数-->
    <select id="deliveryCounts" parameterType="map" resultType="int">
        select count(1) from doctor_pig_events
        where type = 15
        <include refid="criteria"/>
    </select>

    <!-- 产活仔数-->
    <select id="deliveryLiveCounts" parameterType="map" resultType="int">
        select sum(live_count) from doctor_pig_events
        where type = 15
        <include refid="criteria"/>
    </select>

    <!-- 产健仔数-->
    <select id="deliveryHealthCounts" parameterType="map" resultType="int">
        select sum(health_count) from doctor_pig_events
        where type = 15
        <include refid="criteria"/>
    </select>

    <!-- 产弱仔数-->
    <select id="deliveryWeakCounts" parameterType="map" resultType="int">
        select sum(weak_count) from doctor_pig_events
        where type = 15
        <include refid="criteria"/>
    </select>

    <!-- 产死仔数-->
    <select id="deliveryDeadCounts" parameterType="map" resultType="int">
        select sum(dead_count) from doctor_pig_events
        where type = 15
        <include refid="criteria"/>
    </select>

    <!-- 产木乃伊数-->
    <select id="deliveryMnyCounts" parameterType="map" resultType="int">
        select sum(mny_count) from doctor_pig_events
        where type = 15
        <include refid="criteria"/>
    </select>

    <!-- 总产仔数-->
    <select id="deliveryAllCounts" parameterType="map" resultType="int">
        select sum(health_count+ weak_count+ jx_count+ mny_count+ dead_count + black_count) from doctor_pig_events
        where type = 15
        <include refid="criteria"/>
    </select>

    <!-- 窝均健仔数-->
    <select id="deliveryHealthCountsAvg" parameterType="map" resultType="double">
        select sum(health_count)/count(1) from doctor_pig_events
        where type = 15
        <include refid="criteria"/>
    </select>

    <!-- 窝均产仔数-->
    <select id="deliveryAllCountsAvg" parameterType="map" resultType="double">
        select sum(health_count+ weak_count+ jx_count+ mny_count+ dead_count + black_count)/count(1) from doctor_pig_events
        where type = 15
        <include refid="criteria"/>
    </select>

    <!-- 窝均活仔数-->
    <select id="deliveryLiveCountsAvg" parameterType="map" resultType="double">
        select sum(live_count)/count(1) from doctor_pig_events
        where type = 15
        <include refid="criteria"/>
    </select>

    <!-- 断奶母猪数-->
    <select id="weanSowCounts" parameterType="map" resultType="int">
        select count(1) from doctor_pig_events
        where type = 16
        <include refid="criteria"/>
    </select>

    <!-- 断奶仔猪数-->
    <select id="weanPigletCounts" parameterType="map" resultType="int">
        select sum(wean_count) from doctor_pig_events
        where type = 16
        <include refid="criteria"/>
    </select>

    <!-- 断奶仔猪均重-->
    <select id="weanPigletWeightAvg" parameterType="map" resultType="double">
        select sum(wean_count*wean_avg_weight)/sum(wean_count) from doctor_pig_events
        where type = 16
        <include refid="criteria"/>
    </select>

    <!-- 窝均断奶数-->
    <select id="weanPigletCountsAvg" parameterType="map" resultType="double">
        select sum(wean_count)/count(1) from doctor_pig_events
        where type = 16
        <include refid="criteria"/>
    </select>

    <!-- 销售情况: 母猪 -->
    <select id="getSaleSow" parameterType="map" resultType="int">
        SELECT
          count(1)
        FROM doctor_pig_events
        WHERE
          change_type_id = 109 AND  -- 变动类型是销售
          type = 6 AND              -- 事件类型是离场
          kind = 1                  -- 猪类母猪
        <include refid="criteria"/>
    </select>

    <!-- 销售情况: 公猪 -->
    <select id="getSaleBoar" parameterType="map" resultType="int">
        SELECT
         count(1)
        FROM doctor_pig_events
        WHERE
          change_type_id = 109 AND  -- 变动类型是销售
          type = 6 AND              -- 事件类型是离场
          kind = 2                  -- 猪类公猪
        <include refid="criteria"/>
    </select>

    <!-- 销售情况: 保育猪（产房+保育） -->
    <select id="getSaleNursery" parameterType="map" resultType="int">
        SELECT
          sum(quantity)
        FROM doctor_group_events
        WHERE
          change_type_id = 109 AND  -- 变动类型是销售
          pig_type IN (1, 2);       -- 产房 + 保育
        <include refid="criteria"/>
    </select>

    <!-- 销售情况: 育肥猪 -->
    <select id="getSaleFatten" parameterType="map" resultType="int">
        SELECT
          sum(quantity)
        FROM doctor_group_events
        WHERE
          change_type_id = 109 AND  -- 变动类型是销售
          pig_type = 3              -- 育肥猪
        <include refid="criteria"/>
    </select>

    <!-- 死淘情况: 母猪 -->
    <select id="getDeadSow" parameterType="map" resultType="int">
        SELECT
          count(1)
        FROM doctor_pig_events
        WHERE
          change_type_id IN (110, 111) AND  -- 变动类型是死亡和淘汰
          type = 6 AND                      -- 事件类型是离场
          kind = 1                          -- 猪类母猪
        <include refid="criteria"/>
    </select>

    <!-- 死淘情况: 公猪 -->
    <select id="getDeadBoar" parameterType="map" resultType="int">
        SELECT
          count(1)
        FROM doctor_pig_events
        WHERE
          change_type_id IN (110, 111) AND  -- 变动类型是死亡和淘汰
          type = 6 AND                      -- 事件类型是离场
          kind = 2                          -- 猪类公猪
        <include refid="criteria"/>
    </select>

    <!-- 死淘情况: 产房仔猪 -->
    <select id="getDeadFarrow" parameterType="map" resultType="int">
        SELECT
          sum(quantity)
        FROM doctor_group_events
        WHERE
          change_type_id IN (110, 111) AND  -- 变动类型是死亡和淘汰
          pig_type = 1                      -- 产房仔猪
        <include refid="criteria"/>
    </select>

    <!-- 死淘情况: 保育猪 -->
    <select id="getDeadNursery" parameterType="map" resultType="int">
        SELECT
          sum(quantity)
        FROM doctor_group_events
        WHERE
          change_type_id IN (110, 111) AND  -- 变动类型是死亡和淘汰
          pig_type = 2                      -- 保育猪
        <include refid="criteria"/>
    </select>

    <!-- 死淘情况: 育肥猪 -->
    <select id="getDeadFatten" parameterType="map" resultType="int">
        SELECT
          sum(quantity)
        FROM doctor_group_events
        WHERE
          change_type_id IN (110, 111) AND  -- 变动类型是死亡和淘汰
          pig_type = 3                      -- 育肥猪
        <include refid="criteria"/>
    </select>

    <!-- 死淘情况: 产房死淘率 -->
    <select id="getDeadFarrowRate" parameterType="map" resultType="double">
        SELECT
          a.dead_count / (b.trans_in_count + c.farrow_count)
        FROM
        (
            SELECT
              farm_id,
              sum(quantity) AS dead_count
            FROM doctor_group_events
            WHERE
              change_type_id IN (110, 111) AND   -- 变动类型是死亡和淘汰
              pig_type IN (1, 7)                 -- 产房仔猪
              <include refid="criteria"/>
        ) AS a
        LEFT JOIN
        (
            SELECT
              farm_id,
              sum(quantity) AS trans_in_count
            FROM doctor_group_events
            WHERE
              pig_type IN (1, 7) AND     -- 产房仔猪
              type = 2 AND               -- 转入猪群事件
              trans_group_type != 0      -- 排除掉内转
              <include refid="criteria"/>
        ) AS b
          ON a.farm_id = b.farm_id
        LEFT JOIN
        (
            SELECT
              farm_id,
              farrow_count               -- 当天产房仔猪存栏
            FROM doctor_daily_reports
            WHERE
              farm_id = #{farmId} AND
              sum_at = date_format(#{endAt}, '%Y-%m-%d')
        ) AS c
        ON a.farm_id = c.farm_id
    </select>

    <!-- 死淘情况: 保育死淘率 -->
    <select id="getDeadNurseryRate" parameterType="map" resultType="double">
        SELECT
          a.dead_count / (b.trans_in_count + c.farrow_count)
        FROM
        (
            SELECT
              farm_id,
              sum(quantity) AS dead_count
            FROM doctor_group_events
            WHERE
              change_type_id IN (110, 111) AND   -- 变动类型是死亡和淘汰
              pig_type = 2                       -- 保育猪
              <include refid="criteria"/>
        ) AS a
        LEFT JOIN
        (
            SELECT
              farm_id,
              sum(quantity) AS trans_in_count
            FROM doctor_group_events
            WHERE
                pig_type = 2 AND           -- 保育猪
                type = 2 AND               -- 转入猪群事件
                trans_group_type != 0      -- 排除掉内转
            <include refid="criteria"/>
        ) AS b
        ON a.farm_id = b.farm_id
        LEFT JOIN
        (
            SELECT
              farm_id,
              nursery_count              -- 当天保育存栏
            FROM doctor_daily_reports
            WHERE
              farm_id = #{farmId} AND
              sum_at = date_format(#{endAt}, '%Y-%m-%d')
        ) AS c
        ON a.farm_id = c.farm_id
    </select>

    <!-- 死淘情况: 育肥死淘率 -->
    <select id="getDeadFattenRate" parameterType="map" resultType="double">
        SELECT
          a.dead_count / (b.trans_in_count + c.farrow_count)
        FROM
        (
            SELECT
              farm_id,
              sum(quantity) AS dead_count
            FROM doctor_group_events
            WHERE
              change_type_id IN (110, 111) AND   -- 变动类型是死亡和淘汰
              pig_type = 3                       -- 育肥猪
              <include refid="criteria"/>
        ) AS a
        LEFT JOIN
        (
            SELECT
              farm_id,
              sum(quantity) AS trans_in_count
            FROM doctor_group_events
            WHERE
              pig_type = 3 AND           -- 育肥猪
              type = 2 AND               -- 转入猪群事件
              trans_group_type != 0      -- 排除掉内转
              <include refid="criteria"/>
        ) AS b
        ON a.farm_id = b.farm_id
        LEFT JOIN
        (
            SELECT
              farm_id,
              fatten_count               -- 当天育肥存栏
            FROM doctor_daily_reports
            WHERE
              farm_id = #{farmId} AND
              sum_at = date_format(#{endAt}, '%Y-%m-%d')
        ) AS c
        ON a.farm_id = c.farm_id;
    </select>

</mapper>