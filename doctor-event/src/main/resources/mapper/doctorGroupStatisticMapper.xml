<?xml version="1.0" encoding="UTF-8" ?>
<!--
  ~ Copyright (c) 2016 杭州端点网络科技有限公司, Code Generated by terminus code gen
  -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="DoctorGroupStatistic">

    <sql id="groupCriteria">
        status = 1
        AND event_source != 5
        <if test="pigType != null">AND pig_type = #{pigType}</if>
        <if test="sumAt != null">AND event_at = #{sumAt}</if>
        <if test="startAt != null">AND event_at &gt;= #{startAt}</if>
        <if test="endAt != null">AND event_at &lt;= #{endAt}</if>
    </sql>

    <select id="realTimeLiveStockGroup" parameterType="map" resultType="int">
        select
        (
        select ifnull(quantity, 0)
        from doctor_group_tracks a left join doctor_groups b on a.group_id = b.id
        WHERE b.farm_id = #{farmId} and b.pig_type = #{pigType}
        )
        -
        (
        select
        ifnull(
        sum(
        CASE WHEN TYPE = 2 THEN quantity ELSE 0 END -
        CASE WHEN TYPE IN (3, 4, 9) THEN quantity ELSE 0 END -
        CASE WHEN TYPE = 5 THEN 1 ELSE 0 END
        )
        ,0)
        from doctor_group_events
        WHERE b.farm_id = #{farmId} and b.pig_type = #{pigType}
        and event_at &gt;=  date_add(date(#{date}), INTERVAL 1 day)  -- 当前23:59:59
        and status = 1
        and event_source != 5
        and `type` in(2,3,4,5,9)
        )
    </select>

    <select id="turnInto" parameterType="map" resultType="int">
        SELECT
        if(sum(quantity),0)
        from doctor_group_events
        WHERE
        <include refid="groupCriteria"/>
        and trans_group_type = 1
    </select>

    <select id="chgFarmIn" parameterType="map" resultType="int">
        SELECT
        if(sum(quantity),0)
        from doctor_group_events
        WHERE
        <include refid="groupCriteria"/>
        and trans_group_type = 1
        and in_type = 5
    </select>

    <select id="turnIntoWeight" parameterType="map" resultType="double">
        SELECT
        if(sum(weight),0)
        from doctor_group_events
        WHERE
        <include refid="groupCriteria"/>
        and trans_group_type = 1
    </select>

    <select id="chgFarm" parameterType="map" resultType="int">
        SELECT
        if(sum(quantity),0)
        from doctor_group_events
        <include refid="groupCriteria"/>
        and `type` = 9
    </select>

    <select id="chgFarmWeight" parameterType="map" resultType="double">
        SELECT
        if(sum(weight),0)
        from doctor_group_events
        <include refid="groupCriteria"/>
        and `type` = 9
    </select>

    <select id="sale" parameterType="map" resultType="int">
        SELECT
        if(sum(quantity),0)
        from doctor_group_events
        <include refid="groupCriteria"/>
        and `type` = 3
        and change_type_id = 109
    </select>

    <select id="saleWeight" parameterType="map" resultType="double">
        SELECT
        if(sum(weight),0)
        from doctor_group_events
        <include refid="groupCriteria"/>
        and `type` = 3
        and change_type_id = 109
    </select>

    <select id="dead" parameterType="map" resultType="int">
        SELECT
        if(sum(quantity),0)
        from doctor_group_events
        <include refid="groupCriteria"/>
        and `type` = 3
        and change_type_id = 110
    </select>

    <select id="weedOut" parameterType="map" resultType="int">
        SELECT
        if(sum(quantity),0)
        from doctor_group_events
        <include refid="groupCriteria"/>
        and `type` = 3
        and change_type_id = 111
    </select>

    <select id="otherChange" parameterType="map" resultType="int">
        select
        ifnull(sum(quantity), 0)
        from doctor_group_events
        where
        <include refid="groupCriteria"/>
        and `type` = 3
        and change_type_id not in (109, 110, 111)
    </select>

    <select id="toNursery" parameterType="map" resultType="int">
        SELECT
        ifnull(sum(quantity), 0)
        from doctor_group_events
        where
        <include refid="groupCriteria"/>
        and `type` = 4
        and trans_group_type = 1
    </select>

    <select id="toFatten" parameterType="map" resultType="int">
        SELECT
        ifnull(sum(quantity), 0)
        from doctor_group_events
        where
        <include refid="groupCriteria"/>
        and `type` = 4
        and trans_group_type = 1
        and other_barn_type = 3
    </select>

    <select id="toFattenWeight" parameterType="map" resultType="double">
        SELECT
        ifnull(sum(weight), 0)
        from doctor_group_events
        where
        <include refid="groupCriteria"/>
        and `type` = 4
        and trans_group_type = 1
        and other_barn_type = 3
    </select>

    <select id="toHoubei" parameterType="map" resultType="int">
        SELECT
        ifnull(sum(quantity), 0)
        from doctor_group_events
        where
        <include refid="groupCriteria"/>
        and `type` = 4
        and trans_group_type = 1
        and other_barn_type = 4
    </select>

    <select id="toHoubeiWeight" parameterType="map" resultType="double">
        SELECT
        ifnull(sum(weight), 0)
        from doctor_group_events
        where
        <include refid="groupCriteria"/>
        and `type` = 4
        and trans_group_type = 1
        and other_barn_type = 4
    </select>

    <select id="turnSeed" parameterType="map" resultType="int">
        SELECT
        ifnull(sum(quantity), 0)
        from doctor_group_events
        where
        <include refid="groupCriteria"/>
        and `type` = 5
    </select>

    <select id="turnOutWeight" parameterType="map" resultType="double">
        SELECT
        ifnull(sum(weight), 0)
        from doctor_group_events
        where
        <include refid="groupCriteria"/>
        and `type` in (3,4,5,9)
        and trans_group_type = 1
    </select>

</mapper>